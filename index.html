<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Art Studio Pro</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1b26;
            color: #a9b1d6;
            overflow: hidden;
            touch-action: none; /* Prevent browser zooming */
        }
        .font-pixel { font-family: 'Press Start 2P', cursive; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1a1b26; }
        ::-webkit-scrollbar-thumb { background: #414868; border-radius: 3px; }
        
        .checkered-bg {
            background-image: 
                linear-gradient(45deg, #2a2b36 25%, transparent 25%), 
                linear-gradient(-45deg, #2a2b36 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #2a2b36 75%), 
                linear-gradient(-45deg, transparent 75%, #2a2b36 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        canvas { 
            image-rendering: pixelated; 
        }

        .layer-item.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- ICONS (SVG) ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        // General Icons
        const Save = (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />;
        const Trash2 = (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />;
        const Copy = (p) => <Icon {...p} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} />;
        const RefreshCw = (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>} />;
        const PaletteIcon = (p) => <Icon {...p} path={<><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></>} />;
        const Sliders = (p) => <Icon {...p} path={<><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></>} />;
        const LayersIcon = (p) => <Icon {...p} path={<><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>} />;
        const Eye = (p) => <Icon {...p} path={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>} />;
        const EyeOff = (p) => <Icon {...p} path={<><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>} />;
        const Plus = (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />;
        const Minus = (p) => <Icon {...p} path={<line x1="5" y1="12" x2="19" y2="12"/>} />;
        
        // Drawing Icons
        const PenTool = (p) => <Icon {...p} path={<><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></>} />;
        const Pencil = (p) => <Icon {...p} path={<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>} />;
        const Eraser = (p) => <Icon {...p} path={<><path d="M20 20.5H6.8a2.8 2.8 0 0 1-2-2.8V6.8a2.8 2.8 0 0 1 2.8-2.8h8.4"/><path d="M14 2L2 14l10 10 12-12-10-10z"/></>} />;
        const Droplet = (p) => <Icon {...p} path={<path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>} />; // Eyedropper-ish
        const PaintBucket = (p) => <Icon {...p} path={<><path d="M19 11L12 17l-7-7"/><path d="M19 11l-5-5-2 2 5 5 2-2z"/><path d="M5 4l7 7 2-2-7-7-2 2z"/><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2"/></>} />;
        const Download = (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />;
        const GridIcon = (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></>} />;
        const Undo = (p) => <Icon {...p} path={<><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></>} />;

        // --- UTILS ---
        function hexToHSL(H) {
            let r=0,g=0,b=0;
            if(H.length==4){r="0x"+H[1]+H[1];g="0x"+H[2]+H[2];b="0x"+H[3]+H[3];}
            else if(H.length==7){r="0x"+H[1]+H[2];g="0x"+H[3]+H[4];b="0x"+H[5]+H[6];}
            r/=255;g/=255;b/=255;
            let cmin=Math.min(r,g,b),cmax=Math.max(r,g,b),delta=cmax-cmin,h=0,s=0,l=0;
            if(delta==0)h=0;else if(cmax==r)h=((g-b)/delta)%6;else if(cmax==g)h=(b-r)/delta+2;else h=(r-g)/delta+4;
            h=Math.round(h*60);if(h<0)h+=360;l=(cmax+cmin)/2;s=delta==0?0:delta/(1-Math.abs(2*l-1));
            return {h, s:+(s*100).toFixed(1), l:+(l*100).toFixed(1)};
        }
        function hslToHex(h,s,l) {
            s/=100;l/=100;let c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs(((h/60)%2)-1)),m=l-c/2,r=0,g=0,b=0;
            if(0<=h&&h<60){r=c;g=x;b=0;}else if(60<=h&&h<120){r=x;g=c;b=0;}else if(120<=h&&h<180){r=0;g=c;b=x;}else if(180<=h&&h<240){r=0;g=x;b=c;}else if(240<=h&&h<300){r=x;g=0;b=c;}else if(300<=h&&h<360){r=c;g=0;b=x;}
            r=Math.round((r+m)*255).toString(16);g=Math.round((g+m)*255).toString(16);b=Math.round((b+m)*255).toString(16);
            return "#"+(r.length==1?"0"+r:r)+(g.length==1?"0"+g:g)+(b.length==1?"0"+b:b);
        }

        // --- SUB-COMPONENTS ---

        // Palette Generator Tab
        const PaletteGenerator = ({ savedPalettes, setSavedPalettes, onSelectColor }) => {
            const [baseColor, setBaseColor] = useState('#3b82f6');
            const [steps, setSteps] = useState(5);
            const [contrast, setContrast] = useState(15);
            const [hueShift, setHueShift] = useState(10);
            const [satShift, setSatShift] = useState(10);

            const palette = useMemo(() => {
                const { h: baseH, s: baseS, l: baseL } = hexToHSL(baseColor);
                const colors = [];
                const midPoint = (steps - 1) / 2;
                for (let i = 0; i < steps; i++) {
                    const offset = i - midPoint;
                    let h = (baseH + (offset * hueShift)) % 360; if(h<0)h+=360;
                    let s = Math.max(0, Math.min(100, baseS + (offset * satShift * -0.5)));
                    let l = Math.max(0, Math.min(100, baseL + (offset * contrast)));
                    colors.push(hslToHex(h, s, l));
                }
                return colors;
            }, [baseColor, steps, contrast, hueShift, satShift]);

            const copyToClipboard = (text) => {
                const ta = document.createElement("textarea"); ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px";
                document.body.appendChild(ta); ta.focus(); ta.select(); 
                try{ document.execCommand('copy'); } catch(e){} 
                document.body.removeChild(ta);
            };

            return (
                <div className="flex flex-col h-full overflow-y-auto p-4 md:p-8 gap-8">
                    <div className="flex flex-col lg:flex-row gap-8">
                        {/* Controls */}
                        <div className="lg:w-1/3 space-y-6">
                            <div className="bg-[#1f2937] p-5 rounded-2xl border border-gray-700 shadow-xl">
                                <label className="block text-gray-400 text-xs font-bold uppercase mb-3">Màu Chủ Đạo</label>
                                <div className="flex gap-4">
                                    <div className="relative w-24 h-24 rounded-2xl overflow-hidden ring-4 ring-gray-600 shrink-0">
                                        <input type="color" value={baseColor} onChange={(e)=>setBaseColor(e.target.value)} className="absolute -top-8 -left-8 w-40 h-40 cursor-pointer"/>
                                    </div>
                                    <div className="flex-1 flex flex-col justify-center gap-2">
                                        <input type="text" value={baseColor.toUpperCase()} onChange={(e)=>setBaseColor(e.target.value)} className="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 text-white font-mono text-xl focus:outline-none focus:border-blue-500 uppercase"/>
                                        <button onClick={()=>setBaseColor('#'+Math.floor(Math.random()*16777215).toString(16))} className="text-xs text-blue-400 hover:underline flex items-center gap-1"><RefreshCw size={12}/> Random Color</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="bg-[#1f2937] p-5 rounded-2xl border border-gray-700 shadow-xl space-y-4">
                                <div>
                                    <div className="flex justify-between text-xs mb-1"><span className="text-gray-400">Steps</span><span className="text-blue-400 font-bold">{steps}</span></div>
                                    <input type="range" min="2" max="32" value={steps} onChange={(e)=>setSteps(Number(e.target.value))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"/>
                                </div>
                                <div>
                                    <div className="flex justify-between text-xs mb-1"><span className="text-gray-400">Contrast</span><span className="text-yellow-400 font-bold">{contrast}%</span></div>
                                    <input type="range" min="5" max="30" value={contrast} onChange={(e)=>setContrast(Number(e.target.value))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500"/>
                                </div>
                                <div>
                                    <div className="flex justify-between text-xs mb-1"><span className="text-gray-400">Hue Shift</span><span className="text-purple-400 font-bold">{hueShift}°</span></div>
                                    <input type="range" min="0" max="60" value={hueShift} onChange={(e)=>setHueShift(Number(e.target.value))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-500"/>
                                </div>
                            </div>
                        </div>

                        {/* Preview */}
                        <div className="lg:w-2/3 flex flex-col gap-6">
                            <div className="bg-[#1f2937] p-6 rounded-3xl border border-gray-700 shadow-2xl flex flex-col items-center">
                                <div className="flex w-full rounded-2xl overflow-hidden shadow-lg h-32 md:h-40 ring-4 ring-gray-800">
                                    {palette.map((c, i) => (
                                        <div key={i} className="flex-1 color-swatch cursor-pointer group relative" style={{backgroundColor:c}} 
                                            onClick={()=>{copyToClipboard(c); onSelectColor(c);}} title="Click: Copy & Use">
                                            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition bg-black/20 text-white font-mono text-xs md:text-sm backdrop-blur-sm">{c}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-6 flex flex-wrap gap-2 justify-center">
                                    {palette.map((c, i) => (
                                        <div key={i} className="flex flex-col items-center gap-1" onClick={()=>onSelectColor(c)}>
                                            <div className="w-8 h-8 rounded border border-gray-600 cursor-pointer" style={{backgroundColor:c}}></div>
                                            <span className="text-[10px] text-gray-500 font-mono uppercase">{c}</span>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={()=>{setSavedPalettes([{id:Date.now(), colors:palette, base:baseColor}, ...savedPalettes])}} className="mt-6 bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 shadow-lg transition">
                                    <Save size={18}/> Lưu Bảng Màu
                                </button>
                            </div>

                            {/* Saved List */}
                            {savedPalettes.length > 0 && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {savedPalettes.map(p => (
                                        <div key={p.id} className="bg-[#1f2937] p-3 rounded-xl border border-gray-700 hover:border-gray-500 transition">
                                            <div className="flex h-8 rounded overflow-hidden mb-2 ring-1 ring-gray-600">
                                                {p.colors.map((c,i)=><div key={i} className="flex-1 cursor-pointer" style={{backgroundColor:c}} onClick={()=>onSelectColor(c)}></div>)}
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-xs text-gray-500 font-mono">{p.base}</span>
                                                <button onClick={()=>{if(confirm('Xóa?')) setSavedPalettes(savedPalettes.filter(x=>x.id!==p.id))}} className="text-gray-600 hover:text-red-500"><Trash2 size={14}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Pixel Editor Tab
        const PixelEditor = ({ selectedColor, setSelectedColor, savedPalettes }) => {
            const [size, setSize] = useState(16); // 16, 32, 64, 500
            const [inputSize, setInputSize] = useState(16);
            const [tool, setTool] = useState('pencil'); // pencil, eraser, fill, picker
            const [showGrid, setShowGrid] = useState(true);
            
            // Layers System
            const [layers, setLayers] = useState([{ id: 1, name: 'Layer 1', visible: true, pixels: {} }]);
            const [activeLayerId, setActiveLayerId] = useState(1);
            
            // History stores { layers, activeLayerId }
            const [history, setHistory] = useState([]);
            const [historyStep, setHistoryStep] = useState(-1);
            
            // Pan & Zoom
            const [scale, setScale] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            
            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const isDrawing = useRef(false);
            const isPanning = useRef(false);
            const lastMousePos = useRef({ x: 0, y: 0 });

            // Init History
            useEffect(() => {
                if (historyStep === -1) {
                    pushHistory(layers, 1);
                }
            }, []);

            const pushHistory = (currentLayers, currentActiveId) => {
                const newHistory = history.slice(0, historyStep + 1);
                // Deep clone layers
                const layersClone = JSON.parse(JSON.stringify(currentLayers));
                newHistory.push({ layers: layersClone, activeLayerId: currentActiveId });
                if(newHistory.length > 30) newHistory.shift();
                setHistory(newHistory);
                setHistoryStep(newHistory.length - 1);
                setLayers(layersClone);
            };

            const handleUndo = () => {
                if (historyStep > 0) {
                    const prev = history[historyStep - 1];
                    setLayers(prev.layers);
                    setActiveLayerId(prev.activeLayerId);
                    setHistoryStep(historyStep - 1);
                }
            };

            // Canvas & Pixel Logic
            const getCoords = (clientX, clientY) => {
                if (!canvasRef.current) return {x:0, y:0};
                const rect = canvasRef.current.getBoundingClientRect();
                const x = Math.floor((clientX - rect.left) / (rect.width / size));
                const y = Math.floor((clientY - rect.top) / (rect.height / size));
                return { x, y };
            };

            const paintPixel = (x, y, targetLayers) => {
                if (x < 0 || x >= size || y < 0 || y >= size) return;
                const key = `${x},${y}`;
                const layerIndex = targetLayers.findIndex(l => l.id === activeLayerId);
                if (layerIndex === -1 || !targetLayers[layerIndex].visible) return;

                if (tool === 'pencil') {
                    targetLayers[layerIndex].pixels[key] = selectedColor;
                } else if (tool === 'eraser') {
                    delete targetLayers[layerIndex].pixels[key];
                }
            };

            const floodFill = (startX, startY, currentLayers) => {
                const layerIndex = currentLayers.findIndex(l => l.id === activeLayerId);
                if (layerIndex === -1 || !currentLayers[layerIndex].visible) return currentLayers;

                const pixels = currentLayers[layerIndex].pixels;
                const key = `${startX},${startY}`;
                const targetColor = pixels[key];
                if (targetColor === selectedColor) return currentLayers;

                const newLayers = JSON.parse(JSON.stringify(currentLayers));
                const newPixels = newLayers[layerIndex].pixels;
                const stack = [[startX, startY]];
                
                while (stack.length) {
                    const [x, y] = stack.pop();
                    const k = `${x},${y}`;
                    if (x < 0 || x >= size || y < 0 || y >= size) continue;
                    
                    if (newPixels[k] === targetColor) {
                        newPixels[k] = selectedColor;
                        stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
                    }
                }
                return newLayers;
            };

            const handlePointerDown = (e) => {
                // Check if panning (Space key or Middle mouse)
                if (e.button === 1 || (e.button === 0 && e.getModifierState && e.getModifierState('Space'))) {
                    isPanning.current = true;
                    lastMousePos.current = { x: e.clientX, y: e.clientY };
                    return;
                }

                if(e.button !== 0) return; // Only left click for drawing

                const { x, y } = getCoords(e.clientX, e.clientY);
                
                if (tool === 'picker') {
                    // Find top-most visible color
                    for (let i = layers.length - 1; i >= 0; i--) {
                        if (layers[i].visible && layers[i].pixels[`${x},${y}`]) {
                            setSelectedColor(layers[i].pixels[`${x},${y}`]);
                            setTool('pencil');
                            return;
                        }
                    }
                    return;
                }

                if (tool === 'fill') {
                    const newLayers = floodFill(x, y, layers);
                    pushHistory(newLayers, activeLayerId);
                    return;
                }

                isDrawing.current = true;
                const newLayers = JSON.parse(JSON.stringify(layers));
                paintPixel(x, y, newLayers);
                setLayers(newLayers);
            };

            const handlePointerMove = (e) => {
                if (isPanning.current) {
                    const dx = e.clientX - lastMousePos.current.x;
                    const dy = e.clientY - lastMousePos.current.y;
                    setPan(p => ({ x: p.x + dx, y: p.y + dy }));
                    lastMousePos.current = { x: e.clientX, y: e.clientY };
                    return;
                }

                if (!isDrawing.current) return;
                const { x, y } = getCoords(e.clientX, e.clientY);
                
                // Opt: Mutate local copy then set state to avoid lag on move?
                // For simplicity in React, we update state. Ideally utilize a ref for current draft buffer.
                setLayers(prev => {
                    const next = JSON.parse(JSON.stringify(prev));
                    paintPixel(x, y, next);
                    return next;
                });
            };

            const handlePointerUp = () => {
                if (isPanning.current) {
                    isPanning.current = false;
                    return;
                }
                if (isDrawing.current) {
                    isDrawing.current = false;
                    pushHistory(layers, activeLayerId);
                }
            };

            const handleWheel = (e) => {
                if (e.ctrlKey || e.metaKey) {
                    // Zoom
                    e.preventDefault();
                    const delta = -e.deltaY;
                    setScale(s => Math.max(0.1, Math.min(20, s + (delta * 0.005 * s)))); // Zoom exponential-ish
                } else {
                    // Pan
                    // e.preventDefault(); // Optional, maybe let default scroll happen if fits
                }
            };

            // Render to Canvas
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, size, size);

                // Draw Layers (Bottom to Top)
                layers.forEach(layer => {
                    if (!layer.visible) return;
                    for (let key in layer.pixels) {
                        const [x, y] = key.split(',').map(Number);
                        ctx.fillStyle = layer.pixels[key];
                        ctx.fillRect(x, y, 1, 1);
                    }
                });

                // Grid
                if (showGrid && size <= 100) { // Auto hide grid on large canvas
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
                    ctx.lineWidth = 0.02; // Very thin
                    ctx.beginPath();
                    for (let i = 0; i <= size; i++) {
                        ctx.moveTo(i, 0); ctx.lineTo(i, size);
                        ctx.moveTo(0, i); ctx.lineTo(size, i);
                    }
                    ctx.stroke();
                }
            }, [layers, size, showGrid]);

            // Layer Management
            const addLayer = () => {
                const newId = Date.now();
                const newLayer = { id: newId, name: `Layer ${layers.length + 1}`, visible: true, pixels: {} };
                const newLayers = [...layers, newLayer]; // Add to top
                pushHistory(newLayers, newId);
            };

            const deleteLayer = (id) => {
                if (layers.length <= 1) return;
                const newLayers = layers.filter(l => l.id !== id);
                pushHistory(newLayers, newLayers[newLayers.length - 1].id);
            };

            const toggleLayer = (id) => {
                const newLayers = layers.map(l => l.id === id ? { ...l, visible: !l.visible } : l);
                setLayers(newLayers); // Just toggling vis doesn't necessarily need history push, but can.
            };

            const changeSize = () => {
                const s = parseInt(inputSize);
                if (s > 0 && s <= 500) {
                    if (confirm("Đổi kích thước sẽ xóa bản vẽ hiện tại?")) {
                        setSize(s);
                        setLayers([{ id: 1, name: 'Layer 1', visible: true, pixels: {} }]);
                        setActiveLayerId(1);
                        setHistory([]);
                        setHistoryStep(-1);
                        setPan({x:0, y:0});
                        setScale(1);
                        // reset history manually
                        setTimeout(() => pushHistory([{ id: 1, name: 'Layer 1', visible: true, pixels: {} }], 1), 50);
                    }
                } else {
                    alert("Kích thước từ 1 - 500");
                }
            };

            const exportImage = (scale = 1) => {
                const canvas = document.createElement('canvas');
                canvas.width = size * scale;
                canvas.height = size * scale;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = false;

                layers.forEach(layer => {
                    if (!layer.visible) return;
                    for (let key in layer.pixels) {
                        const [x, y] = key.split(',').map(Number);
                        ctx.fillStyle = layer.pixels[key];
                        ctx.fillRect(x * scale, y * scale, scale, scale);
                    }
                });

                const link = document.createElement('a');
                link.download = `pixel-art-${size}x${size}.png`;
                link.href = canvas.toDataURL();
                link.click();
            };

            return (
                <div className="flex flex-col lg:flex-row h-full overflow-hidden">
                    {/* TOOLS */}
                    <div className="w-full lg:w-16 bg-[#1f2937] border-r border-gray-700 flex lg:flex-col items-center p-2 gap-2 overflow-x-auto lg:overflow-visible shrink-0 z-10">
                        {[
                            { id: 'pencil', icon: <PenTool size={20}/>, label: 'Bút' },
                            { id: 'eraser', icon: <Eraser size={20}/>, label: 'Tẩy' },
                            { id: 'fill', icon: <PaintBucket size={20}/>, label: 'Đổ màu' },
                            { id: 'picker', icon: <Droplet size={20}/>, label: 'Hút màu' },
                        ].map(t => (
                            <button key={t.id} onClick={() => setTool(t.id)} className={`p-3 rounded-xl transition ${tool === t.id ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>
                                {t.icon}
                            </button>
                        ))}
                        <div className="w-px h-8 lg:w-8 lg:h-px bg-gray-700 my-1"></div>
                        <button onClick={handleUndo} className="p-3 rounded-xl bg-gray-800 text-gray-400 hover:text-white"><Undo size={20}/></button>
                        <button onClick={()=>pushHistory(layers.map(l=>l.id===activeLayerId ? {...l, pixels:{}} : l), activeLayerId)} className="p-3 rounded-xl bg-gray-800 text-gray-400 hover:text-red-500"><Trash2 size={20}/></button>
                        
                        <div className="flex-1 lg:h-full"></div>
                        <div className="w-8 h-8 rounded-full border-2 border-white" style={{backgroundColor: selectedColor}}></div>
                    </div>

                    {/* MAIN CANVAS */}
                    <div className="flex-1 bg-[#111827] relative overflow-hidden flex flex-col" ref={containerRef}>
                        {/* Top Bar */}
                        <div className="h-12 bg-[#1f2937] border-b border-gray-700 flex items-center px-4 justify-between shrink-0 z-10">
                            <div className="flex items-center gap-2">
                                <input type="number" value={inputSize} onChange={e=>setInputSize(e.target.value)} className="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-white"/>
                                <button onClick={changeSize} className="px-3 py-1 bg-blue-600 text-xs rounded font-bold hover:bg-blue-500">Set Size</button>
                                <span className="text-gray-500 text-xs ml-2">{size}x{size}</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={()=>setShowGrid(!showGrid)} className={`p-2 rounded ${showGrid ? 'text-blue-400' : 'text-gray-400'}`}><GridIcon size={16}/></button>
                                <button onClick={()=>exportImage(size < 32 ? 20 : (size < 100 ? 10 : 2))} className="p-2 rounded text-green-400"><Download size={16}/></button>
                            </div>
                        </div>

                        {/* Canvas Viewport */}
                        <div 
                            className="flex-1 relative overflow-hidden checkered-bg cursor-move"
                            onWheel={handleWheel}
                            onPointerDown={handlePointerDown}
                            onPointerMove={handlePointerMove}
                            onPointerUp={handlePointerUp}
                            onPointerLeave={handlePointerUp}
                        >
                            <div style={{
                                transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})`,
                                transformOrigin: '0 0',
                                width: '100%', height: '100%',
                                display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>
                                <canvas
                                    ref={canvasRef}
                                    width={size}
                                    height={size}
                                    className="bg-transparent shadow-2xl"
                                    style={{
                                        width: size, 
                                        height: size, 
                                        border: '1px solid rgba(255,255,255,0.1)',
                                        cursor: tool==='picker'?'copy':'crosshair'
                                    }}
                                />
                            </div>
                        </div>
                    </div>

                    {/* RIGHT PANELS */}
                    <div className="w-full lg:w-64 bg-[#1f2937] border-l border-gray-700 flex flex-col h-1/3 lg:h-full shrink-0 z-10">
                        {/* Layers Panel */}
                        <div className="flex-1 flex flex-col border-b border-gray-700 min-h-0">
                            <div className="p-2 bg-gray-800 font-bold text-xs text-gray-400 uppercase flex justify-between items-center">
                                <div className="flex items-center gap-2"><LayersIcon size={14}/> Layers</div>
                                <button onClick={addLayer} className="hover:text-white"><Plus size={14}/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                {[...layers].reverse().map(l => (
                                    <div 
                                        key={l.id} 
                                        onClick={()=>setActiveLayerId(l.id)}
                                        className={`flex items-center gap-2 p-2 rounded cursor-pointer ${activeLayerId === l.id ? 'bg-blue-600 text-white' : 'hover:bg-gray-700 text-gray-300'}`}
                                    >
                                        <button onClick={(e)=>{e.stopPropagation(); toggleLayer(l.id)}} className="hover:text-gray-100">
                                            {l.visible ? <Eye size={14}/> : <EyeOff size={14}/>}
                                        </button>
                                        <span className="flex-1 text-xs truncate">{l.name}</span>
                                        <button onClick={(e)=>{e.stopPropagation(); deleteLayer(l.id)}} className="text-gray-500 hover:text-red-300"><Trash2 size={12}/></button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Palette Panel */}
                        <div className="h-1/2 flex flex-col">
                            <div className="p-2 bg-gray-800 font-bold text-xs text-gray-400 uppercase flex items-center gap-2">
                                <PaletteIcon size={14}/> Palette
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 content-start">
                                <div className="flex flex-wrap gap-1">
                                    {savedPalettes.flatMap(p => p.colors).map((c, i) => (
                                        <button 
                                            key={i} 
                                            onClick={() => setSelectedColor(c)}
                                            className={`w-6 h-6 rounded border border-gray-600 ${selectedColor === c ? 'ring-2 ring-white z-10' : ''}`}
                                            style={{backgroundColor: c}}
                                        />
                                    ))}
                                    {/* Default Colors */}
                                    {['#000000', '#ffffff', '#ef4444', '#22c55e', '#3b82f6', '#eab308'].map(c => (
                                        <button key={c} onClick={()=>setSelectedColor(c)} className="w-6 h-6 rounded border border-gray-600" style={{backgroundColor:c}}/>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('editor'); // Default to editor for pro feel
            const [savedPalettes, setSavedPalettes] = useState(() => {
                const saved = localStorage.getItem('pixelPalettes');
                return saved ? JSON.parse(saved) : [];
            });
            const [selectedColor, setSelectedColor] = useState('#3b82f6');

            useEffect(() => {
                localStorage.setItem('pixelPalettes', JSON.stringify(savedPalettes));
            }, [savedPalettes]);

            return (
                <div className="h-screen flex flex-col bg-[#111827] text-white">
                    <nav className="h-10 border-b border-gray-700 flex items-center px-4 justify-between bg-[#1f2937] shrink-0 z-50 text-xs">
                        <div className="font-pixel text-blue-400">Pixel Studio Pro</div>
                        <div className="flex gap-4">
                            <button onClick={() => setView('generator')} className={view==='generator'?'text-white font-bold':'text-gray-400'}>Palette Gen</button>
                            <button onClick={() => setView('editor')} className={view==='editor'?'text-white font-bold':'text-gray-400'}>Editor</button>
                        </div>
                    </nav>
                    <div className="flex-1 overflow-hidden relative">
                        {view === 'generator' ? (
                            <PaletteGenerator savedPalettes={savedPalettes} setSavedPalettes={setSavedPalettes} onSelectColor={setSelectedColor} />
                        ) : (
                            <PixelEditor selectedColor={selectedColor} setSelectedColor={setSelectedColor} savedPalettes={savedPalettes} />
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
